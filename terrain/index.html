<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Terrain Demo - PlayfulJS</title>
  </head>
  <body style='background: #000'>
    <canvas id='display' width='1' height='1' />

    <script>

      class Terrain {
        constructor(detail) {
          this.size = Math.pow(2, detail) + 1;
          this.max  = this.size -1;
          this.map  = new Float32Array(this.size * this.size);
        }

        get(x, y) {
          if (x < 0 || x > this.max || y < 0 || y > this.max) return -1;
          return this.map[x + this.size * y];
        }

        set(x, y, val) {
          this.map[x + this.size * y] = val;
        }

        generate(roughness) {

          this.set(0, 0, this.max);
          this.set(this.max, 0, this.max / 2);
          this.set(this.max, this.max, 0);
          this.set(0, this.max, this.max / 2);

          divide.bind(this)(this.max);

          function divide(size) {
            let x, y;
            const half  = size / 2,
                  scale = roughness * size;

            if( half < 1 ) return;

            for (y = half; y < this.max; y += size) {
              for (x = half; x < this.max; x += size) {
                square.bind(this)(x, y, half, Math.random() * scale * 2 - scale);
              }
            }
            for (y = 0; y <= this.max; y += half) {
              for (x = (y + half) % size; x <= this.max; x += size) {
                diamond.bind(this)(x, y, half, Math.random() * scale * 2 - scale);
              }
            }
            divide.bind(this)(size / 2);
          }

          function average(values) {
            const valid = values.filter((val) => val !== -1),
                  total = valid.reduce((sum, val) => sum + val, 0);
            return total / valid.length;
          }

          function square(x, y, size, offset) {
            const ave = average([
              this.get(x - size, y - size),   // upper left
              this.get(x + size, y - size),   // upper right
              this.get(x + size, y + size),   // lower right
              this.get(x - size, y + size)    // lower left
            ]);
            this.set(x, y, ave + offset);
          }

          function diamond(x, y, size, offset) {
            const ave = average([
              this.get(x, y - size),      // top
              this.get(x + size, y),      // right
              this.get(x, y + size),      // bottom
              this.get(x - size, y)       // left
            ]);
            this.set(x, y, ave + offset);
          }
        }

        draw(ctx, width, height) {
          const waterVal = this.size * 0.3;

          for (let y = 0; y < this.size; y++) {
            for (let x = 0; x < this.size; x++) {
              const val    = this.get(x, y),
                    top    = project.bind(this)(x, y, val),
                    bottom = project.bind(this)(x + 1, y, 0),
                    water  = project.bind(this)(x, y, waterVal),
                    style  = brightness.bind(this)(x, y, this.get(x + 1, y) - val);

              rect(top, bottom, style);
              rect(water, bottom, 'rgba(50, 150, 200, 0.15)');
            }
          }

          function rect(a, b, style) {
            if (b.y < a.y) return;
            ctx.fillStyle = style;
            ctx.fillRect(a.x, a.y, b.x - a.x, b.y - a.y);
          }

          function brightness(x, y, slope) {
            if (y === this.max || x === this.max) return '#000';
            const b = ~~(slope * 50) + 128;
            return `rgba(${b}, ${b}, ${b}, 1)`;
          }

          function iso(x, y) {
            return {
              x: 0.5 * (this.size + x - y),
              y: 0.5 * (x + y)
            };
          }

          function project(flatX, flatY, flatZ) {
            const point = iso.bind(this)(flatX, flatY),
                  x0    = width * 0.5,
                  y0    = height * 0.2,
                  z     = this.size * 0.5 - flatZ + point.y * 0.75,
                  x     = (point.x - this.size * 0.5) * 6,
                  y     = (this.size - point.y) * 0.005 + 1;
            return {
              x: x0 + x / y,
              y: y0 + z / y
            };
          }
        }
      }


      const display = document.getElementById('display'),
            ctx     = display.getContext('2d');
            width   = display.width = window.innerWidth;
            height  = display.height = window.innerHeight;
            terrain = new Terrain(9);

      terrain.generate(0.7);
      terrain.draw(ctx, width, height);

    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-50885475-1', 'playfuljs.com');
      ga('send', 'pageview');
    </script>
  </body>
</html>
